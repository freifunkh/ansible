---

- name: Add gpg dependency for apt_key
  apt:
    name: "gpg"

- name: Add Zabbix Repo Key
  apt_key:
    url: "https://repo.zabbix.com/zabbix-official-repo.key"
    state: present
    keyring: /etc/apt/trusted.gpg.d/zabbix.gpg

- name: Add Zabbix Repo
  apt_repository:
    repo: "deb https://repo.zabbix.com/zabbix/{{ zabbix_server_version | default('5.0') }}/debian {{ ansible_distribution_release }} main"
    state: present
    filename: zabbix

- name: Install zabbix-agent and its dependencies via apt
  apt:
    update_cache: yes
    pkg:
    - zabbix-agent
    - zabbix-sender
    - fping
    - git
    - sudo
    - jo
    - jq

- name: Install additional dependencies for non-buster-backport machines
  apt:
    pkg:
    - dbus-user-session # let normal users execute systemctl # install breaks on buster/backports for systemd 247
  when: not zabbix_agent_skip_additionals

- name: Create ferm directory if necessary
  file:
    path: /etc/ferm/conf.d
    state: directory

- name: Open zabbix-agent port in firewall (ferm)
  notify: reload ferm
  template:
    src: ferm.conf.j2
    dest: "/etc/ferm/conf.d/50-zabbix-agent.conf"
    owner: "root"
    group: "root"
    mode: "0644"

- name: Deploy zabbix-agent config file (DIFF REDACTED)
  notify: reload zabbix-agent
  template:
    src: agent.conf.j2
    dest: "/etc/zabbix/zabbix_agentd.d/ansible.conf"
    owner: "zabbix"
    group: "zabbix"
    mode: "0644"
  diff: "{{ show_secret_diffs }}"

- name: Deploy generic sudoers file for user zabbix
  template:
    src: sudoers.j2
    dest: "/etc/sudoers.d/90-zabbix"
    owner: "root"
    group: "root"
    mode: "0440"

- name: Disable session login for zabbix in pam
  lineinfile:
    path: "/etc/pam.d/sudo"
    line: "session [success=1 default=ignore] pam_succeed_if.so quiet uid = 0 ruser = zabbix"
    regexp: "^session.*quiet uid = 0 ruser = zabbix"
    insertbefore: "^@include common-session-noninteractive"

- name: Deploy additional configuration files in /etc
  notify: reload zabbix-agent
  copy:
    src: "etc/"
    dest: "/etc/"

- name: Deploy additional configuration files in /usr/bin
  notify: reload zabbix-agent
  copy:
    src: "usr/bin/"
    dest: "/usr/bin"
    mode: 0755

- name: Set x attribute on /etc/zabbix/bin/
  command: "/bin/sh -c 'chmod a+x /etc/zabbix/bin/*'"

- name: Deploy zabbix-agent PSK file (DIFF REDACTED)
  notify: reload zabbix-agent
  template:
    src: zabbix_agentd.psk.j2
    dest: "/etc/zabbix/zabbix_agentd.d/secret.psk"
    owner: "zabbix"
    group: "zabbix"
    mode: "0755"
  diff: "{{ show_secret_diffs }}"

- name: Enable and start zabbix-agent
  systemd:
    name: "zabbix-agent"
    enabled: yes
    state: "started"
