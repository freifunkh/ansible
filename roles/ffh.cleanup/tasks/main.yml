---
# This file should regularly be cleaned up, so we can remove outdated stuff.

# PR #236: https://github.com/freifunkh/ansible/pull/236

- name: "#236: remove add-vx-to-batX@.service files"
  ansible.builtin.file:
    path: /etc/systemd/system/add-{{ vxlan_iface_prefix }}-to-batX@.service
    state: absent
  register: add_vx_to_batx

- name: "#236: disable add-vx-to-batX@.service services"
  systemd:
    name: add-{{ vxlan_iface_prefix }}-to-batX@{{ item.id }}
    enabled: no
  with_items:
    - "{{ domains }}"
  when: add_vx_to_batx is changed

- name: "#236: remove add-gt-to-batX@.service files"
  ansible.builtin.file:
    path: /etc/systemd/system/add-gt-to-batX@.service
    state: absent
  register: add_gt_to_batx

- name: "#236: disable add-gt-to-batX@.service services"
  systemd:
    name: add-gt-to-batX@{{ item.id }}
    enabled: no
  with_items:
    - "{{ domains }}"
  when: add_gt_to_batx is changed

- name: "#236: remove 19-vlan-gt.network (since they are now iface specific versions)"
  ansible.builtin.file:
    path: /etc/systemd/network/19-vlan-gt.network
    state: absent

- name: "#236: Remove ffh_fix_vx.sh"
  ansible.builtin.file:
    path: /usr/bin/ffh_fix_vx.sh
    state: absent

- name: "#236: Remove ffh_fix_vx.sh cronjob"
  ansible.builtin.cron:
    name: "call ffh_fix_vx every 5mins"
    minute: "*/5"
    job: "test -x /usr/bin/ffh_fix_vx.sh && /usr/bin/ffh_fix_vx.sh"
    user: "root"
    state: absent

# 224 Retiring addr-gen-mode-hotfix

- name: "#224 Check if add-gen-mode services exists"
  register: addrgenmode_installed
  stat:
    path: "/etc/systemd/system/addr-gen-mode.service" 

- name: '#224'
  block:
  - name: "#224: Disable addr-gen-mode service"
    systemd:
      name: "addr-gen-mode.service"
      enabled: no
    register: addr_gen_mode_changed
  - name: "#224: Remove addr-gen-mode service"
    ansible.builtin.file:
      path: "/etc/systemd/system/addr-gen-mode.service"
      state: absent
    when: addr_gen_mode_changed is changed
  - name: "#224: Remove sysctl file"
    ansible.builtin.file:
      path: "/etc/sysctl.d/99-addr_gen_mode.conf"
      state: absent
  when: addrgenmode_installed.stat.exists

# ### Deprecate wait-for

- name: "Disable wait-for servicefile for each bat interface"
  systemd:
    name: "wait-for-ip@bat{{ domain.id }}.service"
    enabled: "no"
  with_items: "{{ domains }}"
  loop_control:
    loop_var: "domain"
  when: "domains is defined"

- name: "Disable wait-for servicefile for dom0"
  systemd:
    name: "wait-for-ip@bat0.service"
    enabled: "no"
  when: "legacy_dom0 == true"

- name: Remove wait-for-ip
  ansible.builtin.file:
    path: /usr/bin/wait-for-ip
    state: absent

- name: Remove wait-for-iface
  ansible.builtin.file:
    path: /usr/bin/wait-for-iface
    state: absent

- name: Remove wait_for_iface.sh legacy link
  ansible.builtin.file:
    path: /usr/bin/wait_for_iface.sh
    state: absent

- name: Remove wait-for-ip system service file
  notify: "systemd daemon-reload"
  ansible.builtin.file:
    path: /etc/systemd/system/wait-for-ip@.service
    state: absent