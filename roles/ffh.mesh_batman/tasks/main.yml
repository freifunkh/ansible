---

- name: Include 'Build from source'
  include_tasks: build_from_source.yml
  when: batman_build_from_source

- name: Check if bat0 exists
  register: bat0_exists
  cmd:
    ip a show bat0
  ignore_errors: yes

- name: Install batctl
  apt: name=batctl
  when: not batman_build_from_source

- name: Install autostart batman_adv on boot
  lineinfile: dest=/etc/modules line=batman_adv

- name: Load batman_adv module
  modprobe: name=batman_adv state=present

- name: Restart mesh_fastd
  service: name=fastd@mesh_fastd state=restarted
  when: installedversion is changed and bat0_exists.cmd.rc == 0

# SMELL: Should not depend on bat0 (legacy_dom0 may be false)
- name: Restart domain fastds
  service: name=fastd@mesh_fastd_{{ domain.id }} state=restarted
  with_items: "{{ domains }}"
  loop_control:
    loop_var: domain
  when: domains is defined and installedversion is changed and bat0_exists.cmd.rc == 0
