---

- name: Install kea-dhcp4-server as dhcpd
  apt: name=kea-dhcp4-server update_cache=yes

- name: Remove artifact kea-dhcp4-server sysv script
  file:
    path: /etc/init.d/kea-dhcp4-server
    state: absent

- name: Remove artifact kea-dhcp4-server rc entries
  command: update-rc.d kea-dhcp4-server remove
  
- name: Add a ramdisk entry in fstab
  notify: Restart dhcpd
  mount: name=/var/lib/kea src=tmpfs fstype=tmpfs opts='defaults,size=10M' state=mounted

- name: Generate kea-dhcp4.conf config
  notify: Restart dhcpd
  template:
    src: dhcpd.conf.j2
    dest: /etc/kea/kea-dhcp4.conf

- name: Generate dhcpd bat0 config
  notify: Restart dhcpd
  template:
    src: bat0.conf.j2
    dest: /etc/kea/bat0.conf
  when: legacy_dom0 == true

- name: Domain configs
  include_tasks: per_domain.yml
  with_items: "{{ domains }}"
  loop_control:
    loop_var: domain
  when: domains is defined

- name: Generate firewall config stanza (ferm)
  register: ferm_changed
  template:
    src: ferm.conf.j2
    dest: /etc/ferm/conf.d/50-dhcpd.conf
  notify: reload ferm

- name: Deploy systemd service file
  template:
    src: dhcpd.service.j2
    dest: /etc/systemd/system/dhcpd.service

- name: Stop dhcpd via systemd
  systemd:
    name: dhcpd
    state: stopped
    enabled: no
  ignore_errors: yes

- name: Reload systemd daemon
  command: systemctl daemon-reload

- name: Enable dhcpd
  command: systemctl enable dhcpd

- name: Start dhcpd
  command: systemctl start dhcpd
