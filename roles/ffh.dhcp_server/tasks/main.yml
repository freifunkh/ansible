---

- name: Install dnsmasq as dhcpd
  apt: name=dnsmasq update_cache=yes

- name: Remove dpkg artifact dnsmasq sysv script
  file:
    path: /etc/init.d/dnsmasq
    state: absent

- name: Remove dpkg artifact dnsmasq rc entries
  command: update-rc.d dnsmasq remove

- name: Remove dpkg artifact dnsmasq insserv script
  file:
    path: /etc/insserv.conf.d/dnsmasq
    state: absent
  
- name: Add a ramdisk entry in fstab
  notify: Restart dhcpd
  mount: name=/var/lib/dnsmasq src=tmpfs fstype=tmpfs opts='defaults,size=30M' state=mounted

- name: Generate dnsmasq.conf config
  notify: Restart dhcpd
  template:
    src: dhcpd.conf.j2
    dest: /etc/dnsmasq.conf

- name: Generate firewall config stanza (ferm)
  register: ferm_changed
  template:
    src: ferm.conf.j2
    dest: /etc/ferm/conf.d/50-dhcpd.conf
  notify: reload ferm

- name: Deploy systemd service file
  template:
    src: dhcpd.service.j2
    dest: /etc/systemd/system/dhcpd.service

- name: Stop dhcpd via systemd
  systemd:
    name: dhcpd
    state: stopped
    enabled: no
  ignore_errors: yes

- name: Reload systemd daemon
  command: systemctl daemon-reload

- name: Enable dhcpd
  command: systemctl enable dhcpd

- name: Start dhcpd
  command: systemctl start dhcpd
