---

- hosts: ruettgers
  pre_tasks:
    - name: "Import pre_tasks: reboot-required.yml"
      import_tasks: "include/reboot-required.yml"
      tags: [always]
  roles:
    - { name: ffh.ferm, tags: ferm }
    - { name: ffh.journald, tags: journald }
    - { name: ffh.admin, tags: admin }
    - { name: ffh.cli_tools, tags: cli_tools }
    - { name: ffh.simple_mail, tags: simple_mail }
    - { name: ffh.cron-apt, tags: cron-apt }
    - { name: ffh.zabbix-agent, tags: zabbix-agent }
    # Backups
    - { name: ffh.restic, tags: restic }
  tasks:
    - name: "Install git, ansible and stuff"
      apt:
        pkg:
        - git
        - ansible
        - pip
        - sudo
        - rsync

    - name: Create auto user
      register: createuser
      user:
        name: auto
        system: yes
        generate_ssh_key: yes

    - name: Configure git
      become_user: auto
      shell: "git config --global pull.ff only"

    - name: Clone the ansible git
      become: yes
      become_user: auto
      git:
        repo: "https://github.com/freifunkh/ansible"
        dest: /home/auto/ansible
        accept_hostkey: true

    - name: Install PIP dependencies
      pip:
        executable: pip3
        name:
          - python-dateutil
          - pytz

    - name: Install daily cronjob
      cron:
        name: Daily ansible dry-run
        user: auto
        job: "cd /home/auto/ansible; tests/cron.sh"
        hour: "5"
        minute: "30"
